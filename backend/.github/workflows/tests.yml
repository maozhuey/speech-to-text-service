name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 每天UTC 2:00运行完整测试套件
    - cron: '0 2 * * *'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, "3.10", "3.11"]
        test-group:
          - unit
          - integration
          - e2e
          - performance

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio pytest-xdist
        pip install pytest-mut pytest-sugar pytest-html

    - name: Run unit tests
      if: matrix.test-group == 'unit'
      run: |
        pytest tests/test_basic.py tests/test_vad_tracker.py tests/test_vad_service.py -v --cov=app --cov-report=xml --cov-report=html

    - name: Run integration tests
      if: matrix.test-group == 'integration'
      run: |
        pytest tests/test_integration.py tests/test_middleware.py tests/test_api_endpoints.py -v --cov=app --cov-append

    - name: Run E2E tests
      if: matrix.test-group == 'e2e'
      run: |
        pytest tests/test_websocket_e2e.py tests/test_websocket_coverage.py -v --cov=app --cov-append

    - name: Run performance tests
      if: matrix.test-group == 'performance'
      run: |
        pytest tests/test_performance.py -v -m "slow" --cov=app --cov-append --benchmark-json=output.json

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.9'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-${{ matrix.test-group }}

    - name: Archive coverage reports
      if: matrix.python-version == '3.9'
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-${{ matrix.test-group }}
        path: htmlcov/

  performance-regression:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio pytest-benchmark

    - name: Run performance benchmarks
      run: |
        pytest tests/test_performance.py -v -m "slow" --benchmark-only --benchmark-json=benchmark.json

    - name: Store benchmark result
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'pytest'
        output-file-path: benchmark.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: false
        alert-threshold: '200%'
        comment-on-alert: true
        fail-on-alert: true
        alert-comment-cc-users: '@maintainer'

  mutation-test:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-mut

    - name: Run mutation tests
      run: |
        pytest --mutate app/core/vad_tracker.py app/core/config.py -v --no-cov
      continue-on-error: true

    - name: Upload mutation report
      uses: actions/upload-artifact@v3
      with:
        name: mutation-report
        path: .mutation-report/

  security-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install security tools
      run: |
        pip install bandit safety

    - name: Run Bandit security linter
      run: |
        bandit -r app/ -f json -o bandit-report.json || true

    - name: Check dependencies for vulnerabilities
      run: |
        safety check --json --output safety-report.json || true

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
